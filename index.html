<!DOCTYPE html><html lang="ja"><head><meta charset="UTF-8"><title>STG</title>
<style>body{margin:0;background:#000;display:flex;justify-content:center;align-items:center;height:100vh;}canvas{background:#111;border:1px solid #555;}</style>
</head><body><canvas id="game" width="400" height="600"></canvas>
<script>
const c=document.getElementById("game"),x=c.getContext("2d");
let state="title",keys={},fireRate=200,lastShot=0,shotLevel=1,sGauge=0,sReady=false;
let bullets=[],enemies=[],eBullets=[],items=[],boss=null,lastEnemy=0,score=0,over=false;
let warn=false,warnTime=0;
const p={x:c.width/2,y:c.height-40,w:12,h:12,s:4};
document.onkeydown=e=>keys[e.key]=true;
document.onkeyup=e=>keys[e.key]=false;

function shoot(){
  const t=performance.now(); if(t-lastShot<fireRate)return; lastShot=t;
  const max=shotLevel,sp=0.4,ang=[];
  if(max===1)ang.push(0); else for(let i=0;i<max;i++)ang.push((i/(max-1)-0.5)*sp);
  ang.forEach(a=>bullets.push({x:p.x,y:p.y-15,w:4,h:10,vx:Math.sin(a)*4,vy:-7}));
}

function special(){sReady=false;sGauge=0;enemies=[];eBullets=[];score+=50;}

function spawnEnemy(t){
  if(t-lastEnemy<1200)return;
  lastEnemy=t;
  let type="normal",hp=1,r=Math.random();
  if(r<0.15){type="homing";hp=2;}
  else if(r<0.30){type="ram";hp=3;}
  else if(r<0.40){type="split";hp=2;}
  enemies.push({x:Math.random()*(c.width-30)+15,y:-20,w:30,h:20,s:1.5,type,hp,state:"aim",aTime:t,split:false,sTime:0});
}

function eShoot(e,t){
  if(t-e.sTime<2000)return;
  e.sTime=t;
  eBullets.push({x:e.x,y:e.y,w:6,h:6,s:2,a:Math.atan2(p.y-e.y,p.x-e.x),born:t});
}

function updEB(t){
  for(let i=eBullets.length-1;i>=0;i--){
    let b=eBullets[i];
    if(t-b.born>5000){eBullets.splice(i,1);continue;}
    let ta=Math.atan2(p.y-b.y,p.x-b.x),d=ta-b.a;
    d=Math.atan2(Math.sin(d),Math.cos(d)); b.a+=d*0.03;
    b.x+=Math.cos(b.a)*b.s; b.y+=Math.sin(b.a)*b.s;
    if(b.x<0||b.x>c.width||b.y<0||b.y>c.height)eBullets.splice(i,1);
  }
}

function updEnemies(t){
  for(let i=enemies.length-1;i>=0;i--){
    let e=enemies[i];
    if(e.type==="normal")e.y+=e.s;
    if(e.type==="homing"){e.y+=e.s;eShoot(e,t);}
    if(e.type==="ram"){
      if(e.state==="aim"){
        let a=Math.atan2(p.y-e.y,p.x-e.x);
        e.vx=Math.cos(a)*3; e.vy=Math.sin(a)*3;
        if(t-e.aTime>600)e.state="dash";
      }else{e.x+=e.vx;e.y+=e.vy;}
    }
    if(e.type==="split"&&!e.split&&e.y>200){
      enemies.push({x:e.x-10,y:e.y,w:20,h:15,s:2,type:"normal",hp:1});
      enemies.push({x:e.x+10,y:e.y,w:20,h:15,s:2,type:"normal",hp:1});
      e.split=true;
    }
    if(e.y-e.h>c.height)enemies.splice(i,1);
  }
}

function spawnBoss(){
  boss={x:c.width/2,y:100,w:120,h:60,hp:80,sTime:0,bx:c.width/2,range:60};
}

function bossShoot(t){
  if(t-boss.sTime<1000)return;
  boss.sTime=t;
  [-0.3,0,0.3].forEach(a=>eBullets.push({x:boss.x,y:boss.y,w:8,h:8,s:3,a:a+Math.PI/2,born:t}));
}

function updBoss(t){
  if(!boss)return;
  boss.x=boss.bx+Math.sin(t/600)*boss.range;
  bossShoot(t);
  for(let i=bullets.length-1;i>=0;i--){
    if(hit(bullets[i],boss)){
      bullets.splice(i,1); boss.hp--;
      if(boss.hp<=0){boss=null;score+=300;}
    }
  }
}

function hit(a,b){
  return Math.abs(a.x-b.x)<(a.w+b.w)/2 && Math.abs(a.y-b.y)<(a.h+b.h)/2;
}

function checkHit(){
  for(let i=enemies.length-1;i>=0;i--){
    for(let j=bullets.length-1;j>=0;j--){
      if(hit(enemies[i],bullets[j])){
        bullets.splice(j,1); enemies[i].hp--;
        if(enemies[i].hp<=0){
          if(Math.random()<0.3)items.push({x:enemies[i].x,y:enemies[i].y,w:12,h:12,vy:2});
          enemies.splice(i,1); score+=10;
          sGauge+=10; if(sGauge>=100)sReady=true;
        }
        break;
      }
    }
  }
}

function updItems(){
  for(let i=items.length-1;i>=0;i--){
    let it=items[i]; it.y+=it.vy;
    if(hit(it,p)){items.splice(i,1);shotLevel=Math.min(5,shotLevel+1);continue;}
    if(it.y>c.height+20)items.splice(i,1);
  }
}

function updBul(){
  for(let i=bullets.length-1;i>=0;i--){
    let b=bullets[i]; b.x+=b.vx;b.y+=b.vy;
    if(b.y<-20||b.x<-20||b.x>c.width+20)bullets.splice(i,1);
  }
}

function draw(){
  x.fillStyle="cyan";
  x.beginPath();x.moveTo(p.x,p.y-p.h/2);x.lineTo(p.x-p.w/2,p.y+p.h/2);x.lineTo(p.x+p.w/2,p.y+p.h/2);x.fill();
  x.fillStyle="yellow"; bullets.forEach(b=>x.fillRect(b.x-b.w/2,b.y-b.h/2,b.w,b.h));
  enemies.forEach(e=>{
    x.fillStyle=e.type==="normal"?"red":e.type==="homing"?"lime":e.type==="ram"?"orange":"pink";
    x.beginPath();x.moveTo(e.x,e.y-e.h/2);x.lineTo(e.x-e.w/2,e.y+e.h/2);x.lineTo(e.x+e.w/2,e.y+e.h/2);x.fill();
  });
  x.fillStyle="orange"; eBullets.forEach(b=>{x.beginPath();x.arc(b.x,b.y,b.w/2,0,7);x.fill();});
  x.fillStyle="cyan"; items.forEach(it=>{x.beginPath();x.arc(it.x,it.y,it.w/2,0,7);x.fill();});
  if(boss){
    x.fillStyle="purple";
    x.beginPath();x.moveTo(boss.x,boss.y-boss.h/2);x.lineTo(boss.x-boss.w/2,boss.y+boss.h/2);x.lineTo(boss.x+boss.w/2,boss.y+boss.h/2);x.fill();
    x.fillStyle="white";x.fillText("BOSS HP:"+boss.hp,boss.x-40,boss.y-boss.h/2-10);
  }
  x.fillStyle="white";x.fillText("SCORE:"+score,10,20);
  x.fillStyle="#444";x.fillRect(10,40,100,12);
  x.fillStyle=sReady?"cyan":"yellow";x.fillRect(10,40,Math.min(sGauge,100),12);
  x.strokeStyle="white";x.strokeRect(10,40,100,12);
  x.fillText("SHOT:"+shotLevel+"WAY",10,70);
  if(warn){
    x.fillStyle="red";x.font="40px sans-serif";x.textAlign="center";
    x.fillText("⚠ WARNING ⚠",c.width/2,c.height/2);
    x.font="20px sans-serif";x.fillText("Boss Approaching...",c.width/2,c.height/2+40);
    x.textAlign="start";
  }
}

function start(){
  state="playing";score=0;sGauge=0;sReady=false;
  bullets=[];enemies=[];eBullets=[];items=[];boss=null;over=false;warn=false;
  shotLevel=1;p.x=c.width/2;p.y=c.height-40;
}

document.addEventListener("keydown",e=>{
  if(e.code==="Enter"&&(state==="title"||state==="gameover"))start();
});

function loop(t){
  x.clearRect(0,0,c.width,c.height);
  if(state==="title"){x.fillStyle="white";x.font="32px sans-serif";x.textAlign="center";x.fillText("SHOOTING GAME",200,250);x.font="20px sans-serif";x.fillText("Press ENTER",200,320);x.textAlign="start";return requestAnimationFrame(loop);}
  if(state==="gameover"){x.fillStyle="white";x.font="32px sans-serif";x.textAlign="center";x.fillText("GAME OVER",200,250);x.font="20px sans-serif";x.fillText("Press ENTER",200,320);x.textAlign="start";return requestAnimationFrame(loop);}
  if(!over){
    spawnEnemy(t); updEnemies(t); updEB(t); updBul(); updItems(); checkHit();
    for(let i=eBullets.length-1;i>=0;i--)if(hit(eBullets[i],p))over=true;
    if(!boss&&!warn&&score>=100){warn=true;warnTime=t;}
    if(warn&&t-warnTime>2000){spawnBoss();warn=false;}
    updBoss(t);
    if(keys["ArrowLeft"])p.x-=p.s;
    if(keys["ArrowRight"])p.x+=p.s;
    if(keys["ArrowUp"])p.y-=p.s;
    if(keys["ArrowDown"])p.y+=p.s;
    p.x=Math.max(p.w,Math.min(c.width-p.w,p.x));
    p.y=Math.max(p.h,Math.min(c.height-p.h,p.y));
  }else state="gameover";
  draw();
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);
</script></body></html>
